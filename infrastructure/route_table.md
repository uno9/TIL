## ルートテーブル
作成日：2022/02/21

## AWSルートテーブルとは？
- ネットワーク間でのトラフィック経路を判断するツール
- VPC内のサブネットの動きやゲートウェイからの通信に対して、ルーティングを行うソフト
- 1つのルートテーブルに対して、サブネットは複数個設定することができる


## AWSルートテーブルの概念
- メインルートテーブル 
  - VPCに自動的に割り当てられるルートテーブル
  - 関連付けをしていないサブネットのルーティングも制御することができる
- カスタムルートテーブル
  - カスタムルートテーブル：VPC用に作成するルートテーブル
  - 送信先：トラフィックを送信するIPアドレスの範囲（どこにトラフィックを送信したいか？）
  - ターゲット：送信先トラフィックに使用するゲートウェイ・ネットワークインターフェース
- ルートテーブルの関連付け：ルートテーブルとサブネット、インターネットゲートウェイ、仮想プライベートゲートウェイと関連付けを行うことができる
- サブネットルートテーブル
  - サブネットに関連付けられたルートテーブル
- ローカルルート
  - VPC内での通信を行うデフォルトルート
- ゲートウェイルートテーブル
  - インターネットゲートウェイ・仮想プライベートゲートウェイに関連付けられたルートテーブル

公式ドキュメント：https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/VPC_Route_Tables.html#RouteTables

## AWSルート
- テーブル内のルートは送信先とターゲットを指定するためのもの
  - ルート例：パブリックサブネット-------インターネットゲートウェイ(0.0.0.0/0)
- ローカルルート
  - VPC内での通信を有効にするローカルルートがデフォルトで追加される
  - サブネットルートテーブル・メインルートテーブルでローカルルートを変更、削除することはできない
- カスタムルート
  - 送信先は、VPC内のサブネットのIPv4・IPv6CIDRブロック全体と同じ範囲
  - ターゲットは、NATゲートウェイ・ネットワークインターフェイス・Gateway Load Balancer エンドポイントを設定できる

## ルータとスイッチ
![image](https://user-images.githubusercontent.com/47252405/156005133-ecc3a82e-8a45-4a23-9c8b-8d6af1fce64a.png)

参照: https://milestone-of-se.nesuke.com/nw-basic/as-nw-engineer/osi-reference-model-and-ip-set-model/

## IPパケットの流れ

- ネットワークの通信では、送信先Aから送信先Bに届くまでの間にさまざまな機器が存在する
  - それぞれの機器には、相手先の情報を持っており、送信先Bへどのルータが接続されているか確かめるリレーを行うことで通信をしている
    - どこにどのホストが接続されているか情報を管理するもの：ルーティングテーブル
    -　送信先Aから送信先Bへ通信をする際に、経由すべきルータ：ゲートウェイ
  -　ルートテーブルには、繋がっていない物理ネットワークへの経路情報も保持する必要がある
    -　→ 到達する可能性のあるサブネットへの経路情報はすべて把握する必要があるため
    -　メトリック：　距離
      -　目的のホストまでの複数の経路が存在した場合に、効率的な経路を選択するために登録されている
      -　正確な値が明示されていなくてもルーティングを行うことは可能だが負荷が大きくなる
        -　コストベースのルーティング：　上記のような経路評価方法のこと
    -　ホップ：　ルータを超えること
      -　例：送信先Bは、ルータBからみてルータAを１つ超えた（ホップ）ところにある→距離の話
    -　※ 膨大なIPアドレスを登録するために、サブネットマスクを用い、サブネット単位で複数のホストをまとめて登録することがでrきる「VLSM方式」が一般的になっている

-　Qインターネットに接続されているPCは、インターネット上のすべてのルーティング情報を把握している？
  -　A さまざまな機器全てのルーティングを把握するのはとても複雑で不可能
    -　全ての機器のルーティング情報を保持することは難しいため、ルーティングテーブルを簡素化して管理している
    -　ルーティングテーブルの簡素化
      -　機器は登録せず、デフォルトゲートウェイのみ登録を行う
      -　デフォルトゲートウェイ：　ルーティングテーブルに登録されていないサブネット、ホストへの転送に用いるゲートウェイ
      -　目的のホストの経路情報を持つルータまでパケットが到達できれば、ルータから目的のホストへパケットを届けることができる！という考え方

https://atmarkit.itmedia.co.jp/ait/articles/0111/01/news001.html

## ルーティングの動作

> 1. ルーティング対象のIPパケットを受信する
> 2. 宛先IPアドレスからルーティングテーブル上のルート情報を検索して、転送先を決定する
> 3. レイヤ2ヘッダを書き換えてIPパケットを転送する

→ ルーティングがないとパケットを送信することはできない

https://www.n-study.com/iprouting/routing-behavior/
